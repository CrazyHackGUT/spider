<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

		<title>SPIDER - SourcePawn IDE</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="shortcut icon" href="img/spider.png">

		<style>
			#input {
				height: 400px;
				margin-left: 5px;
			}

			#output {
				height: 200px;
				background-color: transparent;
			}

			.container-fluid {
				padding-top: 20px;
				padding-bottom: 20px;
			}

			.ace_gutter-active-line {
				-moz-border-radius-topleft: 7px;
				-moz-border-radius-bottomleft: 7px;
				border-top-left-radius: 7px;
				border-bottom-left-radius: 7px;
			}

			.ace_scrollbar {
				overflow-y: auto !important;
			}

			.ace_gutter-cell.ace_warning {
				background-image: none !important;
			}

			.ace_gutter-cell.ace_warning:before {
				content: '!';
				position: absolute;
				left: 0;
				color: #FFA300;
				font-size: 14px;
				line-height: 12px;
				font-weight: bolder;
				padding-left: 4px;
				padding-top: 1px;
			}

			.ace_gutter-cell.ace_error {
				background-image: none !important;
			}

			.ace_gutter-cell.ace_error:before {
				content: '\00d7';
				position: absolute;
				left: 0;
				color: #df3c3e;
				font-size: 14px;
				line-height: 12px;
				font-weight: bolder;
				padding-left: 4px;
			}
			
			#gutter {
				position: fixed;
				background-color: #e8e8e8;
				top: 0;
				left: 0;
				bottom: 0;
			}

			#status {
				line-height: 22px;
				padding: 4px 8px;
			}

			.glyphicon {
				vertical-align: text-top;
			}

			#editor-buttons {
				margin-bottom: 15px;
			}

			#editor-buttons input {
				float: left;
				width: 200px;
			}

			#editor-buttons input, #editor-buttons a {
				margin-right: 10px;
				margin-bottom: 5px;
			}

			#includes, #history {
				margin-top: 20px;
				margin-bottom: 0;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row">
				<div class="col-xs-7">
					<div id="gutter" style=""></div>
					<div id="input">#pragma semicolon 1

#include &lt;sourcemod&gt;

public Plugin:myinfo = {
	name        = "",
	author      = "",
	description = "",
	version     = "0.0.0",
	url         = ""
};

public OnPluginStart()
{
	PrintToServer("Hello, World!");
}
</div>
				</div>
				<div class="col-xs-5">
					<div class="row">
						<div id="editor-buttons" class="col-xs-12">
							<input id="filename" class="form-control input-sm" type="text" placeholder="plugin.sp">
							<a id="download-source" href="javascript:void(0)" class="btn btn-sm btn-default" data-toggle="tooltip" title="Download Source Code"><span class="glyphicon glyphicon-save"></span></a>
							<span id="status" class="label label-success pull-right">Downloading...</span>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-12">
							<div class="well well-sm">
								<div id="output"></div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-6">
							<button onclick="javascript:startCompile()" id="compile" class="btn btn-lg btn-block btn-primary" disabled><span class="glyphicon glyphicon-play-circle"></span> Compile</button>
						</div>
						<div class="col-xs-6">
							<a id="download" class="btn btn-default btn-lg btn-block disabled"><span class="glyphicon glyphicon-download"></span> Download</a>
						</div>
					</div>
					<div class="row">
						<div class="col-xs-6">
							<div id="includes" class="list-group">
								<a id="includes-helper" class="list-group-item text-muted"><span class="glyphicon glyphicon-info-sign"></span> Drop thirdparty include files here to use them</a>
							</div>
						</div>
						<div class="col-xs-6">
							<div id="history" class="list-group">
								<a id="history-helper" class="list-group-item text-muted"><span class="glyphicon glyphicon-info-sign"></span> Your last 5 compiled binaries will appear here</a>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="welcome" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
						<h4 class="modal-title">Welcome!</h4>
					</div>
					<div class="modal-body">
						<p><small><strong>SP<span class="text-muted">IDE</span>R</strong></small> is dependent on some fairly recent browser features, if you're not using the latest (and I really mean the latest) version of Chrome, Firefox, or Internet Explorer it'll likely be horribly broken.</p>
						<p>You have been warned.</p>
						<p>P.S. Your browser will hang for a little bit when you hit compile, this is to be expected and should only last a number of seconds.</p>
					</div>
					<div class="modal-footer">
						<button class="btn btn-primary" data-dismiss="modal">Continue</button>
					</div>
				</div>
			</div>
		</div>
		
		<div id="fileError" class="modal fade">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
						<h4 class="modal-title">Error</h4>
					</div>
					<div class="modal-body">
						<p></p>
					</div>
					<div class="modal-footer">
						<button class="btn btn-primary" data-dismiss="modal">Close</button>
					</div>
				</div>
			</div>
		</div>

		<script src="js/jquery.min.js" type="text/javascript"></script>
		<script src="js/bootstrap.min.js" type="text/javascript"></script>
		<script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript">
			// Compat hacks.
			var exitPointerLock = document['exitPointerLock'] || document['mozExitPointerLock'] || document['webkitExitPointerLock'];
			if (!exitPointerLock) {
				document['exitPointerLock'] = function() {};
			}

			window.URL = window.URL || window.webkitURL;

			if (!(('download' in document.createElement('a')) || navigator.msSaveBlob)) {
				var modal = $('#welcome');
				modal.attr('data-backdrop', 'static');
				modal.attr('data-keyboard', false);

				$('#welcome div.modal-header button').remove();

				var button = $('#welcome div.modal-footer button');
				button.text('Your browser is not supported');
				button.removeClass('btn-primary');
				button.addClass('btn-danger');
				button.attr('disabled', true);
			}

			$(window).load(function() {
				$('#welcome').modal('show');
			});

			var sourceName = 'plugin.sp';
			var compiledName = 'plugin.smx';

			$('#filename').change( function() {
				sourceName = $(this).val();

				var dot = sourceName.lastIndexOf('.');

				if (dot == -1) {
					compiledName = sourceName + '.smx';
					sourceName += '.sp';
				} else {
					compiledName = sourceName.substr(0, dot) + '.smx';
				}
			});

			$('#download-source').tooltip({
				'placement': 'right',
				'container': 'body',
				'animation': false,
			});

			$('#download-source').click(function(e) {
				if (navigator.msSaveBlob) {
					var blob = new Blob([input.getValue()], {'type': 'application/octet-stream'});
					navigator.msSaveBlob(sourceName, blob);
				} else {
					var url = URL.createObjectURL(new Blob([input.getValue()], {'type': 'application/octet-stream'}));
					$(this).attr('href', url);
					$(this).attr('download', sourceName);
				}
			});

			window.input = ace.edit('input');
			input.setTheme('ace/theme/xcode');
			input.getSession().setMode('ace/mode/c_cpp');
			input.setShowPrintMargin(false);
			input.setHighlightActiveLine(false);
			input.getSession().setUseWrapMode(true);
			input.getSession().setUseSoftTabs(false);
			input.renderer.setPadding(5);

			window.output = ace.edit('output');
			output.setTheme('ace/theme/xcode');
			output.getSession().setMode('ace/mode/text');
			output.setShowPrintMargin(false);
			output.setReadOnly(true);
			output.setHighlightActiveLine(false);
			output.renderer.setShowGutter(false);
			output.getSession().setUseWrapMode(true);
			output.getSession().setUseSoftTabs(false);
			
			var resizeGutter = function() {
				$("#gutter").width($(".ace_gutter").width() + 20);
			};
			input.renderer.$gutterLayer.on('changeGutterWidth', resizeGutter);
			resizeGutter();

			var resizeAce = function() {
				$('#input').height($(window).height() - 40);
				input.resize();
			};
			$(window).resize(resizeAce);
			resizeAce();

			var startCompile = function() {
				if (FS.root.contents[sourceName]) {
					FS.unlink(sourceName);
				}

				if (FS.root.contents[compiledName]) {
					FS.unlink(compiledName);
				}

				var source = input.getValue();
				FS.createDataFile(FS.root, sourceName, source, true, false);

				output.setValue('');
				input.getSession().setAnnotations([]);

				var download = $('#download');
				download.removeAttr('href');
				download.removeAttr('download');
				download.addClass('disabled');
				download.off('click');

				$('#compile').attr('disabled', true);
				$('#filename').attr('disabled', true);

				Module.setStatus('Running...');
				setTimeout(reallyCompile, 500); // Give the browser a chance to render.
			};
			
			var startTime;

			var reallyCompile = function() {
				startTime = Date.now();

				Module['calledRun'] = false;
				Module['postRun'] = [compiled];
				shouldRunNow = true;
				run([sourceName, '-iinclude', '-ithirdparty']);
			};

			var compiled = function() {
				var elapsedTime = Date.now() - startTime;

				$('#compile').removeAttr('disabled');
				$('#filename').removeAttr('disabled');
				
				if (FS.root.contents[compiledName]) {
					if (!navigator.msSaveBlob) {
						var url = URL.createObjectURL(new Blob([new Uint8Array(FS.root.contents[compiledName].contents)], {'type': 'application/octet-stream'}));

						var download = $('#download');
						download.attr('href', url);
						download.attr('download', compiledName);
						download.removeClass('disabled');
						
						$('#history-helper').addClass('hide');
						
						var historyItems = $('#history > a');
						if (historyItems.length >= 5) {
							var last = historyItems.filter(':last');
							URL.revokeObjectURL(last.attr('href'));
							last.remove();
						}

						var date = new Date();
						var dstring = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' ' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + ':' + ('0' + date.getSeconds()).slice(-2);
						$('#history').prepend('<a class="list-group-item" download="' + compiledName + '" href="' + url + '"><span class="glyphicon glyphicon-download"></span> ' + dstring + '</a>');
					} else {
						var download = $('#download');
						download.attr('href', 'javascript:void(0)');
						download.removeClass('disabled');
						
						$('#history-helper').html('<span class="glyphicon glyphicon-info-sign"></span> If you were using a better browser, your last 5 compiled binaries would appear here');
						
						download.click(function (blob) {
							return function(e) {
								navigator.msSaveBlob(blob, compiledName);
							};
						}(new Blob([new Uint8Array(FS.root.contents[compiledName].contents)], {'type': 'application/octet-stream'})));
					}
				}

				var annotations = [];
				var data = output.getValue().split('\n');
				for (var i = 0; i < data.length; ++i) {
					var m = data[i].match(new RegExp('^' + sourceName.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&") + '\\((\\d+)\\) : (?:fatal )?(\\w+) \\d+: (.+)'));
					if (!m) {
						continue;
					}

					annotations.push({
						column: 0,
						row: m[1] - 1,
						text: m[3],
						type: m[2],
					});
				}
				
				input.getSession().setAnnotations(annotations);

				setTimeout(function() { Module.setStatus("Time: " + elapsedTime + "ms"); }, 100);
			}
			
			window.addEventListener('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
				e.dataTransfer.dropEffect = 'copy';
			}, false);
			
			window.addEventListener('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();

				var files = e.dataTransfer.files;
				if (!files || files.length > 1)
				{
					$('#fileError div.modal-body p').text('Single files only please.');
					$('#fileError').modal('show');
					return;
				}
				
				var file = files[0];
				if (!file.type.match(/^text/) && !file.name.match(/\.(sp|inc)$/)) {
					$('#fileError div.modal-body p').text('Text files only please.');
					$('#fileError').modal('show');
					return;
				}
				
				var reader = new FileReader();
				
				reader.onload = (function(theFile) {
					return function(e) {
						input.setValue(e.target.result);
						input.clearSelection();
						input.scrollToLine(0, false, false);
						input.getSession().setAnnotations([]);

						output.setValue('');

						sourceName = theFile.name;
						compiledName = sourceName.substr(0, sourceName.lastIndexOf('.')) + '.smx';

						$('#filename').val(sourceName);
					};
				})(file);
				
				reader.readAsText(file);
			}, false);
			
			$('#includes')[0].addEventListener('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();

				var files = e.dataTransfer.files;
				if (!files)
				{
					$('#fileError div.modal-body p').text('Text files only please.');
					$('#fileError').modal('show');
					return;
				}
				
				for (var i = 0, file; file = files[i]; i++) {
					if (!file.type.match('^text') && !file.name.match('\.(sp|inc)$')) {
						$('#fileError div.modal-body p').text('Text files only please.');
						$('#fileError').modal('show');
						continue;
					}
					
					var reader = new FileReader();
					
					reader.onload = (function(theFile) {
						return function(e) {
							FS.createDataFile('thirdparty', theFile.name, e.target.result, true, false);
							
							$('#includes-helper').addClass('hide');
							$('#includes').append('<a class="list-group-item" href="javascript:void(0)" onclick="deleteIncludeFile(this);"><span class="glyphicon glyphicon-trash"></span> ' + theFile.name + '</a>');
						};
					})(file);
					
					reader.readAsText(file);
				}
			}, false);
			
			var deleteIncludeFile = function(elem) {
				FS.unlink('thirdparty/' + $(elem).text().trim());
				$(elem).parent().remove();
				
				if ($('#includes > a').length <= 1) {
					$('#includes-helper').removeClass('hide');
				}
			};

			var Module = {
				noInitialRun: true,
				noExitRuntime: true,
				preInit: [function() {
					FS.createFolder(FS.root, 'thirdparty', true, true);
					$('#compile').removeAttr('disabled');
				}],
				preRun: [],
				postRun: [],
				print: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					output.setValue(output.getValue() + text + "\n");
					output.clearSelection();
				},
				printErr: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					console.log(text);
				},
				canvas: {},
				setStatus: function(text) {
					if (Module.setStatus.interval) clearInterval(Module.setStatus.interval);
					var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
					if (m) {
						text = m[1];
					}
					$('#status').text(text);
				},
				totalDependencies: 0,
				monitorRunDependencies: function(left) {
					this.totalDependencies = Math.max(this.totalDependencies, left);
					Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
				}
			};
			Module.setStatus('Downloading...');
		</script>
		<script async src="spcomp.js"></script>
	</body>
</html>

