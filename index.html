<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

		<title>SPIDER - SourcePawn IDE</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="css/bootstrap.min.css">
		<link rel="stylesheet" href="css/font-awesome.min.css">
		<link rel="shortcut icon" href="img/spider.png">

		<style>
			#input {
				height: 400px;
			}

			#output {
				height: 200px;
			}

			.container-fluid {
				padding-top: 20px;
				padding-bottom: 20px;
			}

			.ace_scroller {
				background-color: transparent !important;
			}
			
			.ace_gutter-active-line {
				-moz-border-radius-topleft: 7px;
				-moz-border-radius-bottomleft: 7px;
				border-top-left-radius: 7px;
				border-bottom-left-radius: 7px;
			}

			.ace_scrollbar {
				overflow-y: auto !important;
			}

			.ace_gutter-cell.ace_warning {
				background-image: none !important;
			}

			.ace_gutter-cell.ace_warning:before {
				content: '\f06a';
				position: absolute;
				left: 0;
				font-family: FontAwesome;
				color: #FFA300;
				font-size: 14px;
				line-height: 12px;
				background-color: #FFF;
				border-radius: 7px;
				border: 1px solid #FFA300;
			}

			.ace_gutter-cell.ace_error {
				background-image: none !important;
			}

			.ace_gutter-cell.ace_error:before {
				content: '\f057';
				position: absolute;
				left: 0;
				font-family: FontAwesome;
				color: #df3c3e;
				font-size: 14px;
				line-height: 12px;
				background-color: #FFF;
				border-radius: 7px;
				border: 1px solid #df3c3e;
			}
			
			#gutter {
				position: absolute;
				background-color: #e8e8e8;
				top: 0;
				left: 0;
				bottom: 0;
			}

			#status {
				line-height: 22px;
				padding: 4px 8px;
			}

			#editor-buttons * {
				margin-bottom: 2.127659574468085%;
			}

			#editor-buttons input {
				float: left;
			}

			#editor-buttons a {
				margin-left: 2.127659574468085%;
				margin-right: 2.127659574468085%;
			}

			#includes, #history {
				margin-top: 4.25531914894%;
				margin-bottom: 0;
			}

			.well {
				margin-bottom: 2.127659574468085% !important;
			}
		</style>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span7">
					<div id="gutter" style=""></div>
					<div id="input">#pragma semicolon 1

#include &lt;sourcemod&gt;

public Plugin:myinfo = {
	name        = "",
	author      = "",
	description = "",
	version     = "0.0.0",
	url         = ""
};

public OnPluginStart()
{
	PrintToServer("Hello, World!");
}
</div>
				</div>
				<div class="span5">
					<div class="row-fluid">
						<div id="editor-buttons" class="span12">
							<input id="filename" class="span4" type="text" placeholder="plugin.sp">
							<a id="download-source" href="javascript:void(0)" class="btn" data-toggle="tooltip" title="Download Source Code"><i class="icon-save"></i></a>
							<span id="status" class="label label-success pull-right">Downloading...</span>
						</div>
					</div>
					<div class="row-fluid">
						<div class="span12">
							<div class="well well-small">
								<div id="output"></div>
							</div>
						</div>
					</div>
					<div class="row-fluid">
						<div class="span6">
							<button onclick="javascript:startCompile()" id="compile" class="btn btn-large btn-block btn-primary" disabled><i class="icon-play-circle icon-large icon-white"></i> Compile</button>
						</div>
						<div class="span6">
							<a id="download" class="btn btn-large btn-block disabled"><i class="icon-download icon-large"></i> Download</a>
						</div>
					</div>
					<div class="row-fluid">
						<div class="span6">
							<ul id="includes" class="nav nav-tabs nav-stacked">
								<li id="includes-helper" class="disabled"><a><i class="icon-info-sign"></i> Drop thirdparty include files here to use them</a></li>
							</ul>
						</div>
						<div class="span6">
							<ul id="history" class="nav nav-tabs nav-stacked">
								<li id="history-helper" class="disabled"><a><i class="icon-info-sign"></i> Your last 5 compiled binaries will appear here</a></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>

		<div id="welcome" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="welcome-label" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3 id="welcome-label">Welcome!</h3>
			</div>
			<div class="modal-body">
				<p><small><strong>SP<span class="muted">IDE</span>R</strong></small> is dependent on some fairly recent browser features, if you're not using the latest (and I really mean the latest) version of Chrome, Firefox, or Internet Explorer it'll likely be horribly broken.</p>
				<p>You have been warned.</p>
				<p>P.S. Your browser will hang for a little bit when you hit compile, this is to be expected and should only last a number of seconds.</p>
			</div>
			<div class="modal-footer">
				<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Continue</button>
			</div>
		</div>
		
		<div id="fileError" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="fileError-label" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
				<h3 id="fileError-label">Error</h3>
			</div>
			<div class="modal-body">
				<p></p>
			</div>
			<div class="modal-footer">
				<button class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Close</button>
			</div>
		</div>

		<script src="js/jquery.min.js" type="text/javascript"></script>
		<script src="js/bootstrap.min.js" type="text/javascript"></script>
		<script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>

		<script type="text/javascript">
			// Compat hacks.
			var exitPointerLock = document['exitPointerLock'] || document['mozExitPointerLock'] || document['webkitExitPointerLock'];
			if (!exitPointerLock) {
				document['exitPointerLock'] = function() {};
			}

			window.URL = window.URL || window.webkitURL;

			if (!(('download' in document.createElement('a')) || navigator.msSaveBlob)) {
				var modal = $('#welcome');
				modal.attr('data-backdrop', 'static');
				modal.attr('data-keyboard', false);

				$('#welcome div.modal-header button').remove();

				var button = $('#welcome div.modal-footer button');
				button.text('Your browser is not supported');
				button.removeClass('btn-primary');
				button.addClass('btn-danger');
				button.attr('disabled', true);
			}

			$(window).load(function() {
				$('#welcome').modal('show');
			});

			var sourceName = 'plugin.sp';
			var compiledName = 'plugin.smx';

			$('#filename').change( function() {
				sourceName = $(this).val();

				var dot = sourceName.lastIndexOf('.');

				if (dot == -1) {
					compiledName = sourceName + '.smx';
					sourceName += '.sp';
				} else {
					compiledName = sourceName.substr(0, dot) + '.smx';
				}
			});

			$('#download-source').tooltip({
				'placement': 'right',
				'container': 'body',
				'animation': false,
			});

			$('#download-source').click(function(e) {
				if (navigator.msSaveBlob) {
					var blob = new Blob([input.getValue()], {'type': 'application/octet-stream'});
					navigator.msSaveBlob(sourceName, blob);
				} else {
					var url = URL.createObjectURL(new Blob([input.getValue()], {'type': 'application/octet-stream'}));
					$(this).attr('href', url);
					$(this).attr('download', sourceName);
				}
			});

			window.input = ace.edit('input');
			input.setTheme('ace/theme/xcode');
			input.getSession().setMode('ace/mode/c_cpp');
			input.setShowPrintMargin(false);
			input.setHighlightActiveLine(false);
			input.getSession().setUseWrapMode(true);
			input.getSession().setUseSoftTabs(false);
			input.renderer.setPadding(5);

			window.output = ace.edit('output');
			output.setTheme('ace/theme/xcode');
			output.getSession().setMode('ace/mode/text');
			output.setShowPrintMargin(false);
			output.setReadOnly(true);
			output.setHighlightActiveLine(false);
			output.renderer.setShowGutter(false);
			output.getSession().setUseWrapMode(true);
			output.getSession().setUseSoftTabs(false);
			
			var resizeGutter = function() {
				$("#gutter").width($(".ace_gutter").width() + 20);
			};
			input.renderer.$gutterLayer.on('changeGutterWidth', resizeGutter);
			resizeGutter();

			var resizeAce = function() {
				$('#input').height($(window).height() - 40);
				input.resize();
			};
			$(window).resize(resizeAce);
			resizeAce();

			var startCompile = function() {
				if (FS.root.contents[sourceName]) {
					FS.deleteFile(sourceName);
				}

				if (FS.root.contents[compiledName]) {
					FS.deleteFile(compiledName);
				}

				var source = input.getValue();
				FS.createDataFile(FS.root, sourceName, source, true, false);

				output.setValue('');
				input.getSession().setAnnotations([]);

				var download = $('#download');
				download.removeAttr('href');
				download.removeAttr('download');
				download.addClass('disabled');
				download.off('click');

				$('#compile').attr('disabled', true);
				$('#filename').attr('disabled', true);

				Module.setStatus('Running...');
				setTimeout(reallyCompile, 500); // Give the browser a chance to render.
			};
			
			var startTime;

			var reallyCompile = function() {
				startTime = Date.now();

				Module['postRun'] = [compiled];
				shouldRunNow = true;
				run([sourceName, '-iinclude', '-ithirdparty']);
			};

			var compiled = function() {
				var elapsedTime = Date.now() - startTime;

				$('#compile').removeAttr('disabled');
				$('#filename').removeAttr('disabled');
				
				if (FS.root.contents[compiledName]) {
					if (!navigator.msSaveBlob) {
						var url = URL.createObjectURL(new Blob([new Uint8Array(FS.root.contents[compiledName].contents)], {'type': 'application/octet-stream'}));

						var download = $('#download');
						download.attr('href', url);
						download.attr('download', compiledName);
						download.removeClass('disabled');
						
						$('#history-helper').addClass('hide');
						
						var historyItems = $('#history li');
						if (historyItems.length >= 5) {
							var last = historyItems.filter(':last');
							URL.revokeObjectURL(last.attr('href'));
							last.remove();
						}

						var date = new Date();
						var dstring = date.getDate() + '/' + (date.getMonth() + 1) + '/' + date.getFullYear() + ' ' + ('0' + date.getHours()).slice(-2) + ':' + ('0' + date.getMinutes()).slice(-2) + ':' + ('0' + date.getSeconds()).slice(-2);
						$('#history').prepend('<li><a download="' + compiledName + '" href="' + url + '"><i class="icon-download"></i> <span class="muted">' + dstring + '</span></a></li>');
					} else {
						var download = $('#download');
						download.attr('href', 'javascript:void(0)');
						download.removeClass('disabled');
						
						$('#history-helper').html('<a><i class="icon-info-sign"></i> If you were using a better browser, your last 5 compiled binaries would appear here</a>');
						
						download.click(function (blob) {
							return function(e) {
								navigator.msSaveBlob(blob, compiledName);
							};
						}(new Blob([new Uint8Array(FS.root.contents[compiledName].contents)], {'type': 'application/octet-stream'})));
					}
				}

				var annotations = [];
				var data = output.getValue().split('\n');
				for (var i = 0; i < data.length; ++i) {
					var m = data[i].match(new RegExp('^' + sourceName.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&") + '\\((\\d+)\\) : (?:fatal )?(\\w+) \\d+: (.+)'));
					if (!m) {
						continue;
					}

					annotations.push({
						column: 0,
						row: m[1] - 1,
						text: m[3],
						type: m[2],
					});
				}
				
				input.getSession().setAnnotations(annotations);

				setTimeout(function() { Module.setStatus("Time: " + elapsedTime + "ms"); }, 100);
			}
			
			window.addEventListener('dragover', function(e) {
				e.stopPropagation();
				e.preventDefault();
				e.dataTransfer.dropEffect = 'copy';
			}, false);
			
			window.addEventListener('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();

				var files = e.dataTransfer.files;
				if (!files || files.length > 1)
				{
					$('#fileError div.modal-body p').text('Single files only please.');
					$('#fileError').modal('show');
					return;
				}
				
				var file = files[0];
				if (!file.type.match(/^text/) && !file.name.match(/\.(sp|inc)$/)) {
					$('#fileError div.modal-body p').text('Text files only please.');
					$('#fileError').modal('show');
					return;
				}
				
				var reader = new FileReader();
				
				reader.onload = (function(theFile) {
					return function(e) {
						input.setValue(e.target.result);
						input.clearSelection();
						input.scrollToLine(0, false, false);
						input.getSession().setAnnotations([]);

						output.setValue('');

						sourceName = theFile.name;
						compiledName = sourceName.substr(0, sourceName.lastIndexOf('.')) + '.smx';

						$('#filename').val(sourceName);
					};
				})(file);
				
				reader.readAsText(file);
			}, false);
			
			$('#includes')[0].addEventListener('drop', function(e) {
				e.stopPropagation();
				e.preventDefault();

				var files = e.dataTransfer.files;
				if (!files)
				{
					$('#fileError div.modal-body p').text('Text files only please.');
					$('#fileError').modal('show');
					return;
				}
				
				for (var i = 0, file; file = files[i]; i++) {
					if (!file.type.match('^text') && !file.name.match('\.(sp|inc)$')) {
						$('#fileError div.modal-body p').text('Text files only please.');
						$('#fileError').modal('show');
						continue;
					}
					
					var reader = new FileReader();
					
					reader.onload = (function(theFile) {
						return function(e) {
							FS.createDataFile('thirdparty', theFile.name, e.target.result, true, false);
							
							$('#includes-helper').addClass('hide');
							$('#includes').append('<li><a href="javascript:void(0)" onclick="deleteIncludeFile(this);"><i class="icon-trash"></i> <span class="muted">' + theFile.name + '</span></a></li>');
						};
					})(file);
					
					reader.readAsText(file);
				}
			}, false);
			
			var deleteIncludeFile = function(elem) {
				FS.deleteFile('thirdparty/' + $(elem).text().trim());
				$(elem).parent().remove();
				
				if ($('#includes li').length <= 1) {
					$('#includes-helper').removeClass('hide');
				}
			};

			var Module = {
				noInitialRun: true,
				noExitRuntime: true,
				preInit: [function() {
					FS.createFolder(FS.root, 'thirdparty', true, true);
					$('#compile').removeAttr('disabled');
				}],
				preRun: [],
				postRun: [],
				print: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					output.setValue(output.getValue() + text + "\n");
					output.clearSelection();
				},
				printErr: function(text) {
					text = Array.prototype.slice.call(arguments).join(' ');
					console.log(text);
				},
				canvas: {},
				setStatus: function(text) {
					if (Module.setStatus.interval) clearInterval(Module.setStatus.interval);
					var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
					if (m) {
						text = m[1];
					}
					$('#status').text(text);
				},
				totalDependencies: 0,
				monitorRunDependencies: function(left) {
					this.totalDependencies = Math.max(this.totalDependencies, left);
					Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
				}
			};
			Module.setStatus('Downloading...');

			var decompressWorker = new Worker('js/decompress.js');
			var decompressCallbacks = [];
			var decompressions = 0;
			Module["decompress"] = function(data, callback) {
				var id = decompressCallbacks.length;
				decompressCallbacks.push(callback);
				decompressWorker.postMessage({ data: data, id: id });
				if (Module['setStatus']) {
					decompressions++;
					Module['setStatus']('Decompressing...');
				}
			};
			decompressWorker.onmessage = function(event) {
				decompressCallbacks[event.data.id](event.data.data);
				decompressCallbacks[event.data.id] = null;
				if (Module['setStatus']) {
					decompressions--;
					if (decompressions == 0) {
						Module['setStatus']('');
					}
				}
			};
			var compiledCodeXHR = new XMLHttpRequest();
			compiledCodeXHR.open('GET', 'spcomp.js.compress', true);
			compiledCodeXHR.responseType = 'arraybuffer';
			compiledCodeXHR.onload = function() {
				var arrayBuffer = compiledCodeXHR.response;
				if (!arrayBuffer) throw('Loading compressed code failed.');
				var byteArray = new Uint8Array(arrayBuffer);
				Module.decompress(byteArray, function(decompressed) {
					var blob = new Blob([new Uint8Array(decompressed)], {'type': 'application/javascript'});
					var scriptTag = document.createElement('script');
					scriptTag.setAttribute('type', 'text/javascript');
					scriptTag.setAttribute('src', window.URL.createObjectURL(blob));
					document.body.appendChild(scriptTag);
				});
			};
			compiledCodeXHR.send(null);
			
			var GoSquared = {};
			GoSquared.acct = "GSN-267368-L";
			(function(w){
			function gs(){
				w._gstc_lt = +new Date;
				var d = document, g = d.createElement("script");
				g.type = "text/javascript";
				g.src = "//d1l6p2sc9645hc.cloudfront.net/tracker.js";
				var s = d.getElementsByTagName("script")[0];
				s.parentNode.insertBefore(g, s);
			}
			w.addEventListener("load", gs, false);
			})(window);
		</script>
	</body>
</html>

